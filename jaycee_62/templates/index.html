<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JC-62 Processor Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .register {
            background-color: #374151;
            color: #ffffff;
            min-height: 5rem;
        }
        .register-large {
            min-height: 8rem;
        }
        .hide-scrollbar {
            scrollbar-width: none;  /* Firefox */
            -ms-overflow-style: none;  /* IE and Edge */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;  /* Chrome, Safari and Opera */
        }
    </style>
</head>

<body class="bg-gray-900 p-4">
    <div class="container mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-12 gap-4">
        <!-- Code Editor Section -->
        <div class="col-span-1 lg:col-span-4 bg-gray-800 p-4 rounded-lg">
            <h2 class="text-white text-xl mb-4">Code Editor</h2>
            <textarea id="codeEditor" class="w-full h-64 md:h-96 p-2 font-mono text-lg bg-gray-700 text-white rounded"></textarea>
            <button id="submitCode" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full lg:w-auto">Submit Code</button>
        </div>

        <!-- RAM Section -->
        <div class="col-span-1 lg:col-span-3 bg-gray-800 p-4 rounded-lg">
            <h2 class="text-white text-xl mb-4">RAM</h2>
            <div class="bg-gray-700 p-2 rounded h-64 md:h-96 overflow-y-auto hide-scrollbar">
                <table id="ramTable" class="w-full text-white">
                    <thead>
                        <tr>
                            <th class="text-left px-4 py-2 w-1/4">Address</th>
                            <th class="text-left px-4 py-2 w-1/3">Label</th>
                            <th class="text-left px-4 py-2 w-1/3">Value</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Registers Section -->
        <div class="col-span-1 lg:col-span-5 bg-gray-800 p-4 rounded-lg">
            <h2 class="text-white text-xl mb-4">Registers</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                <div class="register p-2 rounded">
                    <h3>PC</h3>
                    <div id="pc" class="text-xl"></div>
                </div>
                <div class="register p-2 rounded">
                    <h3>ACC</h3>
                    <div id="acc" class="text-xl"></div>
                </div>
                <div class="register p-2 rounded">
                    <h3>B</h3>
                    <div id="b" class="text-xl"></div>
                </div>
                <div class="register p-2 rounded">
                    <h3>MAR</h3>
                    <div id="mar" class="text-xl"></div>
                </div>
                <div class="register p-2 rounded">
                    <h3>MDR</h3>
                    <div id="mdr" class="text-xl"></div>
                </div>
                <div class="register p-2 rounded">
                    <h3>IR</h3>
                    <div id="ir" class="text-xl"></div>
                </div>
                <div class="register p-2 rounded">
                    <h3>NF</h3>
                    <div id="nf" class="text-xl"></div>
                </div>
            </div>
            <div class="mt-4">
                <div class="register register-large p-2 rounded mb-2">
                    <h3>Instruction</h3>
                    <div id="instruction" class="whitespace-pre-line"></div>
                </div>
                <div class="register register-large p-2 rounded">
                    <h3>Comments</h3>
                    <div id="comments" class="whitespace-pre-line"></div>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-1 sm:grid-cols-3 gap-4">
                <button id="step" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Step</button>
                <button id="run" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Run All</button>
                <button id="reset" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Reset</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Modify RAM table initialization
            const ramTable = document.getElementById('ramTable').getElementsByTagName('tbody')[0];
            for (let i = 0; i < 256; i++) {
                const addr = i.toString(16).toUpperCase().padStart(2, '0');
                const row = ramTable.insertRow();
                row.insertCell(0).textContent = addr;
                row.cells[0].classList.add('px-4', 'py-1');

                // Make label cell editable
                const labelCell = row.insertCell(1);
                labelCell.textContent = 'NULL';
                labelCell.setAttribute('contenteditable', 'true');
                labelCell.classList.add('cursor-pointer', 'hover:bg-gray-600', 'px-4', 'py-1', 'outline-none');

                // Make value cell editable
                const valueCell = row.insertCell(2);
                valueCell.textContent = 'NULL';
                valueCell.setAttribute('contenteditable', 'true');
                valueCell.classList.add('cursor-pointer', 'hover:bg-gray-600', 'px-4', 'py-1', 'outline-none');

                // Add event listeners for both cells
                [labelCell, valueCell].forEach(cell => {
                    // Store original value when starting to edit
                    cell.addEventListener('focus', function() {
                        this.dataset.originalValue = this.textContent;
                    });

                    cell.addEventListener('blur', async function() {
                        let newValue = this.textContent.trim();
                        if (newValue === '') {
                            this.textContent = 'NULL';
                            newValue = 'NULL';
                        }

                        const row = this.parentElement;
                        const address = row.cells[0].textContent;
                        const label = row.cells[1].textContent;
                        const value = row.cells[2].textContent;
                        let isValid = true;

                        // Validate value (hex number between 00 and FF)
                        if (this === valueCell && newValue !== 'NULL') {
                            const valueRegex = /^[0-9A-Fa-f]{1,2}$/;
                            if (!valueRegex.test(newValue)) {
                                alert('Value must be a hexadecimal number between 00 and FF');
                                this.textContent = this.dataset.originalValue;
                                isValid = false;
                            } else {
                                // Convert to decimal to check range
                                const decimalValue = parseInt(newValue, 16);
                                if (decimalValue < 0 || decimalValue > 255) {
                                    alert('Value must be between 00 and FF');
                                    this.textContent = this.dataset.originalValue;
                                    isValid = false;
                                } else {
                                    // Pad with leading zero if necessary and convert to uppercase
                                    this.textContent = newValue.toUpperCase().padStart(2, '0');
                                }
                            }
                        }

                        // Validate label (alphanumeric and underscore only)
                        if (this === labelCell && newValue !== 'NULL') {
                            const labelRegex = /^[a-zA-Z0-9_]+$/;
                            if (!labelRegex.test(newValue)) {
                                alert('Label must contain only letters, numbers, and underscores');
                                this.textContent = this.dataset.originalValue;
                                isValid = false;
                            }
                        }

                        if (newValue === '') {
                            this.textContent = 'NULL';
                        }

                        if (isValid && newValue !== this.dataset.originalValue) {
                            try {
                                const response = await fetch('/api/set-ram', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        address,
                                        label: label === 'NULL' ? '' : label,
                                        value: value === 'NULL' ? '' : value
                                    })
                                });

                                if (!response.ok) {
                                    throw new Error('Failed to update RAM value');
                                }
                            } catch (error) {
                                alert(error.message);
                                this.textContent = this.dataset.originalValue;
                            }
                        }
                    });

                    // Handle keyboard events
                    cell.addEventListener('keydown', function(e) {
                        if (e.key === 'Escape') {
                            this.textContent = this.dataset.originalValue;
                            this.blur();
                        } else if (e.key === 'Enter') {
                            e.preventDefault();
                            this.blur();
                        }
                    });
                });
            }

            // Event Listeners
            document.getElementById('submitCode').addEventListener('click', submitCode);
            document.getElementById('step').addEventListener('click', step);
            document.getElementById('run').addEventListener('click', runAll);
            document.getElementById('reset').addEventListener('click', reset);

            // Functions
            async function submitCode() {
                const code = document.getElementById('codeEditor').value;
                const response = await fetch('/api/submit-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });
                const data = await response.json();
                updateUI({});
            }

            async function step() {
                const response = await fetch('/api/step', {
                    method: 'POST'
                });
                const data = await response.json();
                if (!response.ok) {
                    alert(data.error);
                    return;
                }
                updateUI(data);
            }

            async function runAll() {
                const response = await fetch('/api/run', {
                    method: 'POST'
                });
                const data = await response.json();
                if (!response.ok) {
                    alert(data.error);
                    return;
                }
                if (data.results.length > 0) {
                    updateUI(data.results[data.results.length - 1]);
                }
            }

            async function reset() {
                await fetch('/api/reset', {
                    method: 'POST'
                });
                updateUI({
                    pc: '', acc: '', b: '', mar: '', mdr: '', ir: '', nf: '',
                    comments: '', instruction: ''
                });
                // Reset RAM table
                const rows = ramTable.getElementsByTagName('tr');
                for (let row of rows) {
                    row.cells[1].textContent = 'NULL';
                    row.cells[2].textContent = 'NULL';
                }
            }

            function updateUI(data) {
                // Update registers
                document.getElementById('pc').textContent = data.pc || '';
                document.getElementById('acc').textContent = data.acc || '';
                document.getElementById('b').textContent = data.b || '';
                document.getElementById('mar').textContent = data.mar || '';
                document.getElementById('mdr').textContent = data.mdr || '';
                document.getElementById('ir').textContent = data.ir || '';
                document.getElementById('nf').textContent = data.nf || '';
                document.getElementById('instruction').textContent = data.instruction || '';
                document.getElementById('comments').textContent = data.comments || '';


                // Update RAM if provided
                if (data.ram) {
                    const rows = ramTable.getElementsByTagName('tr');
                    for (let row of rows) {
                        const addr = row.cells[0].textContent;
                        if (data.ram[addr]) {
                            row.cells[1].textContent = data.ram[addr].label;
                            row.cells[2].textContent = data.ram[addr].value;
                        }
                    }
                }
            }
        });
            </script>
    </body>

    </html>